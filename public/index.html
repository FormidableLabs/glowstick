<html>
  <head>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/thorax/2.0.0rc3/thorax.js"></script>
    <script src="jquery-color.js"></script>
    <script src="hex-from-color-name.js"></script>
    <script src="index.js"></script>
    <script>
      var output = '<table border="1">';
      _.each(_.range(0, 64), function(i) {
        if (i % 8 === 0) {
          output += '<tr>';
        }
        output += '<td style="width: 50px; height: 50px;">' + i + '</td>';
        if (i % 8 === 7) {
          output += '</tr>';
        }
      });
      output += '</table>';
      $(function() {
        $('#board').append(output);
      });

      function componentToHex(c) {
        var hex = c.toString(16);
        return hex.length == 1 ? "0" + hex : hex;
      }

      function rgbToHex(r, g, b) {
        return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
      }

      var $set = Pixels.prototype.set;
      Pixels.prototype.set = function() {
        $set.apply(this, arguments);
        var color = convertColor.apply(this, arguments);
        var commands = [];
        _.each(this._pixels, function(pixel) {
          commands.push({
            command: 'set',
            index: pixel.index,
            r: color[0],
            g: color[1],
            b: color[2]
          });
          $('td').eq(pixel.index).css({
            backgroundColor: rgbToHex(color[0], color[1], color[2])
          });
        }, this);
        $.ajax({
          type: 'post',
          url: '/update',
          data: {commands: commands}
        });
      };

      var $clear = board.clear;
      board.clear = function() {
        $clear.apply(this, arguments);
        $.ajax({
          type: 'post',
          url: '/clear'
        });
      };

      var $fade = Pixels.prototype.fade;
      Pixels.prototype.fade = function(from, to, duration, callback) {
        $fade.apply(this, arguments);
        var to = convertColor(to);
        var from = convertColor(from);
        var commands = [];
        _.each(this._pixels, function(pixel) {
          //$('td').eq(pixel.index).css({
          //  backgroundColor: rgbToHex(from[0], from[1], from[2])
          //}).animate({
          //  backgroundColor: rgbToHex(to[0], to[1], to[2])
          //}, duration);
          commands.push({
            command: 'fade',
            index: pixel.index,
            from: {
              r: from[0],
              g: from[1],
              b: from[2]
            },
            to: {
              r: to[0],
              g: to[1],
              b: to[2]
            },
            duration: duration
          });
        }, this);
        $.ajax({
          type: 'post',
          url: '/update',
          data: {commands: commands}
        });
      };

      $(function() {
        var input = $('#repl-input'),
            consoleEl = $('#console'),
            button = $('input[type=button]');

        button.click(executeCode);

        function executeCode() {
          var value = input.val();
          try {
            var response = eval(value);
            if (response instanceof Pixels) {
              highlightPixels(response);
            }
            consoleEl.append(response.inspect() + '<br>');
          } catch (e) {
            consoleEl.append(e.message + '<br>');
          }
          input.val('');
        }

        function highlightPixels(pixels) {
          $('#board td').css({backgroundColor: 'transparent'});
          if (pixels) {
            pixels.each(function(pixel) {
              $('#board td').eq(pixel.index).css({
                backgroundColor: '#900'
              });
            });
          }
        }
      });

    </script>
    <style>
      .right {
        width: 300px;
      }

      #repl-input {
        width: 500px;
        font-size:18px;
        margin: 10px;
        font-family: Monaco, courier;
      }

      input[type=button] {
        font-size:24px;
      }
    </style>
  </head>
  <body>
    <table>
      <tr>
        <td class="left">
          <div id="repl">
            <textarea id="repl-input" rows="5"></textarea>
            <input type="button" value="Run">
            <div id="console"></div>
          </div>
          <div id="board"></div>
        </td>
        <td class="right">API</td>
      </tr>
    </table>
  </body>
</html>